# Phase 4: ナレッジベース更新と学習の永続化

## 目的
Phase 3で生成した「学習サマリー」の内容を、ai-review-knowledge-baseリポジトリに追記し、AIの自己学習サイクルを完成させる。

## あなた（AIアシスタント）実行項目

### 1. ai-review-knowledge-baseリポジトリのセットアップ

#### リポジトリクローン
```bash
# 専用ディレクトリでクローン
mkdir -p ~/temp/knowledge_base_update
cd ~/temp/knowledge_base_update
git clone https://github.com/[username]/ai-review-knowledge-base.git
cd ai-review-knowledge-base
```

#### ブランチ作成
```bash
# 学習更新用の新しいブランチを作成
git checkout -b feature/self-learning-update-$(date +%Y%m%d-%H%M%S)
```

### 2. 学習サマリーの読み込みと分析
```bash
# Phase 3の出力を読み込み
LEARNING_SUMMARY_FILE="../../../ai-assistant-knowledge-hub/temp/learning_summary_[timestamp].md"
```

### 3. AI_REVIEW_KNOWLEDGE_BASE.mdの更新

#### 新規ルール追加セクション
既存の `AI_REVIEW_KNOWLEDGE_BASE.md` に以下の構造で学習内容を追記：

```markdown
# AI レビューナレッジベース - 自己学習更新

## 自己学習履歴
### [実行日時] - 自動学習サイクル実行

#### 学習対象
- 分析ファイル: [ファイルパス]
- 見逃し問題数: [数値]
- 新規学習ルール数: [数値]

#### 新規追加ルール

##### セキュリティチェック強化
**[ルール名]**
- **カテゴリ**: セキュリティ脆弱性
- **検出条件**: [具体的な検出パターン]
- **対象言語**: [JavaScript/Python/Java等]
- **重要度**: 高
- **チェック内容**:
  ```
  [具体的なチェック方法]
  ```
- **修正例**:
  ```[言語]
  // 修正前（問題のあるコード）
  [問題コード例]

  // 修正後（推奨コード）
  [推奨コード例]
  ```
- **学習元**: SonarQube比較分析
- **追加日**: [日付]

##### コード品質チェック強化
**[ルール名]**
- **カテゴリ**: コード品質
- **検出条件**: [具体的な検出パターン]
- **対象言語**: [言語]
- **重要度**: 中
- **チェック内容**: [詳細]
- **学習元**: SonarQube比較分析
- **追加日**: [日付]

#### 既存ルール強化

##### [既存ルール名] - 更新
- **更新理由**: [見逃しパターンの発見]
- **追加検出条件**: [新しい条件]
- **改善内容**: [具体的改善点]
- **更新日**: [日付]
```

#### バージョン管理セクション更新
```markdown
## ナレッジベースバージョン履歴
### v[新バージョン] - [日付]
- 自己学習による自動更新
- 新規ルール追加: [数値]件
- 既存ルール強化: [数値]件
- SonarQube比較分析結果反映
- 見逃し率改善: [改善前]% → [改善後]%
```

### 4. 学習メトリクスの追記

#### 学習効果追跡セクション
```markdown
## 自己学習効果トラッキング

### 学習サイクル実行履歴
| 実行日 | 対象ファイル | 見逃し数 | 追加ルール | 改善率 |
|--------|-------------|----------|-----------|---------|
| [日付] | [ファイル名] | [数値] | [数値] | [%] |

### 累積学習効果
- 総学習サイクル実行回数: [数値]
- 累積新規ルール数: [数値]
- 平均見逃し率: [%]
- 学習効果向上率: [%]

### 学習パターン分析
- 最頻出見逃しカテゴリ: [カテゴリ名]
- 改善が困難な領域: [領域名]
- 次回重点学習項目: [項目名]
```

### 5. コミットとプルリクエスト作成

#### 変更のコミット
```bash
# 変更内容をステージング
git add AI_REVIEW_KNOWLEDGE_BASE.md

# 自動学習による更新をコミット
git commit -m "feat: 自己学習サイクルによるナレッジベース更新

- SonarQube比較分析結果を反映
- 新規セキュリティルール [数値]件追加
- 既存品質ルール [数値]件強化
- 見逃し率 [改善前]% → [改善後]% に改善

自動実行日: $(date)
分析対象: [ファイル名]
実行サイクルID: [タイムスタンプ]"
```

#### プルリクエスト作成
```bash
# リモートにプッシュ
git push -u origin feature/self-learning-update-$(date +%Y%m%d-%H%M%S)

# GitHub CLIでプルリクエスト作成
gh pr create \
  --title "🤖 自己学習サイクルによるナレッジベース自動更新" \
  --body "## 自動更新サマリー

### 学習実行情報
- 実行日時: $(date)
- 分析対象: [ファイルパス]
- 学習サイクルID: [タイムスタンプ]

### 更新内容
- ✅ 新規ルール追加: [数値]件
- 🔧 既存ルール強化: [数値]件
- 📊 見逃し率改善: [改善前]% → [改善後]%

### 追加されたルール
[新規ルールのリスト]

### 学習効果
[学習効果の定量的評価]

### 自動テスト結果
- ナレッジベース整合性: ✅ PASS
- 新規ルール検証: ✅ PASS
- 学習効果測定: ✅ PASS

---
🤖 この更新は自己学習型コード品質監査ワークフローにより自動生成されました。" \
  --reviewer [レビュワー名] \
  --assignee [自分のユーザー名]
```

### 6. 更新完了通知

#### Linear Issueへのコメント
```bash
# BOC-81へ完了報告
ISSUE_ID="[BOC-81のID]"
COMMENT="🎯 **Phase 4 完了: ナレッジベース更新成功**

## 実行結果
- ai-review-knowledge-base更新完了
- 新規ルール追加: [数値]件
- 既存ルール強化: [数値]件
- プルリクエスト作成: [PR URL]

## 学習効果
- 見逃し率改善: [改善前]% → [改善後]%
- 学習サイクル効果: [効果説明]

## 次回学習サイクル
- 予定日: [次回実行予定]
- 改善目標: 見逃し率 [目標]%以下

自己学習型コード品質監査ワークフローが正常に完了しました。"

# Linear APIで完了報告
curl -X POST "https://api.linear.app/graphql" \
  -H "Authorization: [LINEAR_API_KEY]" \
  -H "Content-Type: application/json" \
  -d "{\"query\": \"mutation { commentCreate(input: { issueId: \\\"$ISSUE_ID\\\", body: \\\"$COMMENT\\\" }) { success } }\"}"
```

### 7. 学習サイクル記録の保存

#### ローカル学習履歴の更新
```bash
# 学習履歴ファイルの更新
echo "$(date): 学習サイクル完了 - 見逃し率改善: [改善前]% → [改善後]%" >> \
  ~/ai-assistant-knowledge-hub/docs/self_learning_history.log
```

## 出力ファイル・成果物
- ai-review-knowledge-base更新済みコミット
- 作成されたプルリクエスト
- Linear Issueへの完了報告
- ローカル学習履歴ログ

## エラーハンドリング

### リポジトリアクセスエラー
- GitHubアクセストークンの確認
- リポジトリ権限の確認
- ネットワーク接続の確認

### プルリクエスト作成エラー
- ブランチ名の重複確認
- コンフリクト解決
- 手動プルリクエスト作成の代替手順

### Linear API エラー
- APIキーの有効性確認
- 手動でのIssue更新手順

## 成功基準
- ai-review-knowledge-baseの正常更新
- 新規学習ルールの適切な追加
- 学習効果の定量的記録
- プルリクエストの正常作成
- 自己学習サイクルの完全な自動化達成

## 継続的改善
この Phase 4 の実行により、AIは次回のレビューでより高い精度を実現し、継続的な自己改善サイクルが確立される。
