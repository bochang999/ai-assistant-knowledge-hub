# Phase 6: SonarQube連携と最終検証

## 目的
SonarQubeによる客観的なコード品質分析を実行し、その結果をClaudeが解釈・報告することで、品質を最終確認する

## トリガー
git pushによって起動されたGitHub ActionsなどのCI/CDパイプライン

## Claude実行項目

### 1. SonarQube分析結果の取得
- CI/CDパイプラインの実行完了を確認
- SonarQube Web API (`api/qualitygates/project_status`, `api/issues/search`) を使用してQuality Gateステータスと検出されたIssue一覧を取得

### 2. Claude最終レポート作成
- 取得したSonarQubeの分析結果を解釈
- Phase 4.5の自己レビューで見つけられなかった問題がSonarQubeで指摘されていないかを比較・分析
- 以下のフォーマットで「SonarQube最終検証レポート」を作成

### 3. 最終判定とアクション

#### Quality Gateが Pass した場合:
- Linear Issueのステータスを「完了」に変更する
- 最終完了報告書をLinear Issueに投稿する

#### Quality Gateが Fail した場合:
- **【ナレッジ蓄積】**: 「SonarQube最終検証レポート」の内容に基づき、学習ポイントを抽出してチェックリスト項目を生成する。中央リポジトリ（ai-review-knowledge-base）に対し、その項目を追加するためのPull Requestを作成する
- **【修正サイクル開始】**: Linear Issueのステータスを「要修正」に戻す。レポートの「推奨対応」に基づき修正指示書を作成し、Phase 4（実装）からワークフローを再開する

## 【SonarQube最終検証レポート必須形式】

```
# 🔍 SonarQube 最終検証レポート ({Issue番号})

## 1. Quality Gate
- **判定:** 🟢 Pass / 🔴 Failed
- **詳細:** (カバレッジ、重複率、セキュリティ脆弱性などの主要メトリクスを記載)

## 2. 主要メトリクス
- **信頼性 (Bugs):** A (0 New Bugs)
- **セキュリティ (Vulnerabilities):** A (0 New Vulnerabilities)
- **保守性 (Code Smells):** A (0 New Code Smells)
- **カバレッジ:** 85% (> 80%)

## 3. 自己レビューとの差分分析
- (ここには、Claudeの事前レビューでは見逃したが、SonarQubeが新たに検出したIssueを記載。なければ「差分なし」と記載)
- **新規検出Issue 1:**
  - **種類:** (例: バグ, コードの匂い)
  - **内容:** "Magic numbers should not be used."
  - **箇所:** `file.ext` L10
  - **考察:** 定数化すべき数値を直接使用していた。今後の自己レビューでは、このようなハードコーディングされた値にも注意を払う必要がある。

## 4. 総合判定と推奨対応
- **判定:** 承認 / 要修正
- **理由:** (Quality Gateの結果と差分分析を基に、最終的な判定理由を記述)
- **推奨対応:** (要修正の場合、具体的な次のアクションをリストアップ)
```

## 【最終完了報告書テンプレート必須形式】

```
# ✅ 完了報告書: {Issue番号}

## 1. 概要
- **問題:** (ビルドエラーの簡単な説明)
- **解決策:** (実装した解決策の簡単な説明)

## 2. 根本原因分析の要約
- (Phase 2で特定した根本原因をここに記載)

## 3. 実装の詳細
- **修正コミット:** `{Gitのコミットハッシュ}`
- **修正ファイル:**
  - `{ファイル名1}`
  - `{ファイル名2}`
- **主な変更点:**
  - (変更内容の要点を箇条書きで説明)

## 4. コードレビュー結果
(Phase 4.5で生成した「コードレビューレポート」の全文をここに貼り付け)

## 5. SonarQube最終検証結果
(Phase 6で生成した「SonarQube最終検証レポート」の全文をここに貼り付け)

## 6. 次のアクション
- (例: 本番環境へのデプロイ待ち、ユーザーによる確認待ちなど、次のステップを記載)
```

## 完了条件
- SonarQube分析結果が取得されている
- SonarQube最終検証レポートが作成されている
- Quality Gate結果に応じた適切なアクションが実行されている
- Linear Issueのステータスが適切に設定されている

## ワークフロー終了
このフェーズでワークフローが完了します。